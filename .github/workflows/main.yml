name: Covid-Framework-build
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  release:
    types:
      - published
jobs:
   docker:
      runs-on: ubuntu-latest
      steps:
        -
          name: Set up QEMU
          uses: docker/setup-qemu-action@v1
#         -
#           name: Set up Docker Buildx
#           uses: docker/setup-buildx-action@v1
        - 
          name: Cache Docker layers
          uses: actions/cache@v2
          with:
            path: /tmp/.buildx-cache
            key: ${{ runner.os }}-buildx-${{ github.sha }}
            restore-keys: |
              ${{ runner.os }}-buildx-
              
        - 
          name: Log into Github container
          uses: docker/login-action@v1
          with:
            registry: ghcr.io
            username: ${{github.actor}}
            password: ${{secrets.GITHUB_TOKEN}}
          
        -
          name: Build and push
          id: docker_build
          uses: docker/build-push-action@v2
          with:
            push: true
            tags: user/app:latest
        -
          name: Image digest
          run: echo ${{ steps.docker_build.outputs.digest }}
        - 
          name: Move cache
          run: |
            rm -rf /tmp/.buildx-cache
            mv /tmp/.buildx-cache-new /tmp/.buildx-cache
#   build:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Check out
#         uses: actions/checkout@v2
        
#       -
#         name: Set up QEMU
#         uses: docker/setup-qemu-action@v1.2.0
# #       -
# #         name: Set up Docker Buildx
# #         uses: docker/setup-buildx-action@v1.5.1
     
# #       - 
# #         name: Build Image
# #         uses: docker/build-push-action@v2
# #         with:
# #           tags: latest, ${{ github.run_number}}
# #           file: ../../Dockerfile
          
      
#       -
#         name: Docker meta
#         id: docker_meta
#         uses: docker/metadata-action@v3.3.0
#         with:
#           images:
#             ghcr.io/covid-app
#           flavor:
#             latest=false
#           tags:
#             type=raw, value=latest
# #       -
# #         name: Build and Push
# #         id: docker_build
# #         uses: docker/build-push-action@v2
# #         with:
# #           builder: ${{steps.buildx.outputs.name}}
# #           cache-from: type=local,src=/tmp/.buildx-cache
# #           cache-to: type=local,dest=/tmp/.buildx-cache-new
# #           push: ${{ github.event_name != 'pull_request'}}
# #           tags: ${{ steps.docker_meta.outputs.tags}}
# #           labels: ${{ steps.docker_meta.outputs.labels }}
#       -
#         name: Docker build
#         run: docker build -t app:v1 ../../Dockerfile
#       -
#         name: Docker push
#         run: docker push CovidFramework-App/app:v1
#       -
#         name: Show image digest
#         run: echo ${{ steps.docker_build.outputs.digest }}
    
          
